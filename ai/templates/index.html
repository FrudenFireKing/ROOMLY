<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roomly</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Генерация мероприятий в переговорках</h1>

        <div class="input-section">
            <h3>Введите описание или требования:</h3>
            <textarea id="user-input" placeholder="Например: Нужен круглый стол, 4 стула, хорошее освещение, бронирование на понедельник с 10:00 до 12:00"></textarea>
            
            <div class="button-group">
                <button id="generate-image-btn">Составить мероприятие</button>
            </div>
        </div>

        <div class="output-section">
            
            <div id="image-result">
                <h4>Вид переговорки</h4>
                <div id="progress-bar"><div id="progress"></div></div>
                <p id="progress-text">Ожидание генерации...</p>
                <div id="result">
                    <img id="generated-image" src="" alt="" style="display: none;">
                </div>
            </div>

            <div id="requirements-result">
                <h4>Требования к оборудованию комнаты</h4>
                <ul id="requirements-list"></ul>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Function to simulate progress updates
    function updateProgress(startPercent, endPercent, duration, callback) {
        let currentPercent = startPercent;
        const increment = (endPercent - startPercent) / (duration / 100);
        $('#progress').css('width', currentPercent + '%');

        const interval = setInterval(function() {
            currentPercent += increment;
            if (currentPercent >= endPercent) {
                currentPercent = endPercent;
                clearInterval(interval);
            }
            $('#progress').css('width', Math.min(currentPercent, 100) + '%');
        }, 100);

        setTimeout(callback, duration);
    }

    // Handle "Generate Image" button click
    $('#generate-image-btn').click(function() {
        const description = $('#user-input').val();
        if (!description) {
            alert('Пожалуйста, введите описание.');
            $('#progress-text').text('Ошибка: описание не введено');
            $('#progress').css('width', '0%');
            return;
        }

        $('#progress-text').text('Начало генерации изображения...');
        $('#progress').css('width', '0%');
        $('#generated-image').hide();

        // Simulate progress for image generation (e.g., 5 seconds)
        updateProgress(0, 80, 5000, function() {
            $.ajax({
                url: '/generate',
                type: 'POST',
                data: { description: description },
                success: function(response) {
                    if (response.error) {
                        $('#progress-text').text('Ошибка: ' + response.error);
                        $('#progress').css('width', '0%');
                    } else {
                        $('#generated-image').attr('src', response.image).show();
                        $('#progress-text').text(response.status);
                        $('#progress').css('width', '100%');
                    }
                },
                error: function() {
                    $('#progress-text').text('Ошибка сервера при генерации изображения.');
                    $('#progress').css('width', '0%');
                }
            });
        });
    });

    // Handle "Generate Requirements" button click
    $('#generate-image-btn').click(function() {
        const userInput = $('#user-input').val();
        if (!userInput) {
            alert('Пожалуйста, введите текст для анализа.');
            $('#progress-text').text('Ошибка: текст не введён');
            $('#progress').css('width', '0%');
            return;
        }

        $('#requirements-list').empty();
        $('#progress-text').text('Начало анализа требований...');
        $('#progress').css('width', '0%');

        // Simulate progress for requirement analysis (e.g., 2 seconds)
        updateProgress(0, 80, 2000, function() {
            $.ajax({
                url: '/analyze',
                type: 'POST',
                data: { user_input: userInput },
                success: function(response) {
                    if (response.error) {
                        $('#requirements-list').append(`<li>Ошибка: ${response.error}</li>`);
                        $('#progress-text').text('Ошибка: ' + response.error);
                        $('#progress').css('width', '0%');
                    } else {
                        if (response.requirements.length === 0) {
                            $('#requirements-list').append('<li>Требования не найдены.</li>');
                            $('#progress-text').text('Анализ завершён: требования не найдены.');
                        } else {
                            response.requirements.forEach(req => {
                                $('#requirements-list').append(`<li>${req}</li>`);
                            });
                            $('#progress-text').text('Анализ завершён: требования извлечены.');
                        }
                        $('#progress').css('width', '100%');
                    }
                },
                error: function() {
                    $('#requirements-list').append('<li>Ошибка сервера.</li>');
                    $('#progress-text').text('Ошибка сервера при анализе требований.');
                    $('#progress').css('width', '0%');
                }
            });
        });
    });
});
</script>
</body>
</html>