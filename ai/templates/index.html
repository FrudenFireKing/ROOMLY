<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roomly - Генератор переговорных комнат</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>
            <i class="fas fa-magic"></i> Генератор идеальной переговорки
        </h1>

        <div class="input-section">
            <h3><i class="fas fa-edit"></i> Опишите ваши требования:</h3>
            <textarea id="user-input" placeholder="Пример: Нужна переговорка на 8 человек с проектором и телевизором, круглый стол, бронирование на четверг с 14:00 до 16:00"></textarea>
            
            <div class="button-group">
                <button id="generate-btn">
                    <i class="fas fa-bolt"></i> Сгенерировать
                </button>
            </div>
        </div>

        <div class="output-section">
            <div class="results-container">
                <div class="requirements-box">
                    <h4><i class="fas fa-clipboard-list"></i> Ваши требования:</h4>
                    <div class="requirements-content">
                        <ul id="requirements-list">
                            <li class="placeholder">Здесь появятся извлечённые требования</li>
                        </ul>
                    </div>
                    <div class="progress-container">
                        <div id="progress-bar">
                            <div id="progress"></div>
                        </div>
                        <p id="progress-text"><i class="fas fa-sync-alt fa-spin"></i> Ожидание действий...</p>
                    </div>
                </div>

                <div class="image-box">
                    <h4><i class="fas fa-image"></i> Визуализация:</h4>
                    <div class="image-placeholder" id="image-placeholder">
                        <i class="fas fa-camera"></i>
                        <p>Изображение переговорки появится здесь</p>
                    </div>
                    <img id="generated-image" src="" alt="Сгенерированное изображение переговорки" style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    $(document).ready(function() {
        // Анимация прогресса
        function updateProgress(start, end, duration, callback) {
            const progress = $('#progress');
            const progressText = $('#progress-text');
            let current = start;
            const step = (end - start) / (duration / 50);

            const timer = setInterval(() => {
                current += step;
                if (current >= end) {
                    current = end;
                    clearInterval(timer);
                    if (callback) callback();
                }
                progress.css('width', current + '%');
            }, 50);
        }

        // Обработка генерации
        $('#generate-btn').click(function() {
            const description = $('#user-input').val().trim();
            if (!description) {
                $('#progress-text').html('<i class="fas fa-exclamation-triangle"></i> Введите описание');
                $('#progress').css('width', '0%');
                return;
            }

            // Сброс состояния
            $('#requirements-list').empty().append('<li class="loading"><i class="fas fa-spinner fa-spin"></i> Анализ требований...</li>');
            $('#image-placeholder').show();
            $('#generated-image').hide();
            $('#progress-text').html('<i class="fas fa-sync-alt fa-spin"></i> Анализируем запрос...');
            updateProgress(0, 30, 1000);

            // 1. Анализ требований через GigaChat
            $.ajax({
                url: '/analyze',
                type: 'POST',
                data: { user_input: description },
                success: function(response) {
                    $('#requirements-list').empty();
                    
                    if (response.error) {
                        $('#requirements-list').append(`<li class="error"><i class="fas fa-times-circle"></i> ${response.error}</li>`);
                        $('#progress-text').html('<i class="fas fa-times-circle"></i> Ошибка анализа');
                        updateProgress(30, 0, 500);
                        return;
                    }

                    if (response.requirements.length === 0) {
                        $('#requirements-list').append('<li class="empty"><i class="fas fa-info-circle"></i> Требования не обнаружены</li>');
                    } else {
                        response.requirements.forEach(req => {
                            $('#requirements-list').append(`<li><i class="fas fa-check-circle"></i> ${req}</li>`);
                        });
                    }

                    $('#progress-text').html('<i class="fas fa-sync-alt fa-spin"></i> Генерируем изображение...');
                    updateProgress(30, 70, 1500, () => {
                        // 2. Генерация изображения
                        $.ajax({
                            url: '/generate',
                            type: 'POST',
                            data: { description: description },
                            success: function(imgResponse) {
                                if (imgResponse.error) {
                                    $('#progress-text').html(`<i class="fas fa-times-circle"></i> ${imgResponse.error}`);
                                    updateProgress(70, 0, 500);
                                } else {
                                    $('#image-placeholder').hide();
                                    $('#generated-image')
                                        .attr('src', imgResponse.image)
                                        .css('opacity', 0)
                                        .show()
                                        .animate({ opacity: 1 }, 500);
                                    
                                    $('#progress-text').html('<i class="fas fa-check-circle"></i> Готово!');
                                    updateProgress(70, 100, 1000);
                                }
                            },
                            error: function() {
                                $('#progress-text').html('<i class="fas fa-times-circle"></i> Ошибка генерации');
                                updateProgress(70, 0, 500);
                            }
                        });
                    });
                },
                error: function() {
                    $('#requirements-list').empty().append('<li class="error"><i class="fas fa-times-circle"></i> Ошибка сервера</li>');
                    $('#progress-text').html('<i class="fas fa-times-circle"></i> Ошибка соединения');
                    updateProgress(30, 0, 500);
                }
            });
        });
    });
    </script>
</body>
</html>